商用化Wireguard进行功能补充
====

# 资源分发及回收

WireGuard服务端，需要支持多客户端连接(支持1000左右用户)

## IP分配及回收策略

每个客户端连接的时候都需要服务端给分配一个ip，同时发送自己的公钥给服务器，客户端关闭时(断开连接)回收这个ip。

## 设计思路

**IP资源池**
设计使用两个redis集合进行ip资源维护

- **ip_available_set** ： 可用IP

- **ip_used_set**：  已用IP + 客户端公钥

  

1. 上面两个redis集合，`ip_available_set`**只存放ip地址**，`ip_used_set` 存放**已用ip + 客户端的公钥信息**。
2. 服务端启动的时候初始化所有的可用ip地址，存入`ip_available_set`。
3. 客户端的连接请求中有2个参数，上一次连接ip和客户端公钥，如果是第一次连接，ip参数为空。
4. 服务器给客户端的连接响应也包括2个参数，客户端ip和服务器公钥，服务器从`ip_available_set (spop)`取出一个ip，将此ip和客户端公钥进行组合，写入 `ip_used_set (sadd)` 标记为已用，并把这个ip和服务器公钥响应给客户端。
5. 客户端非第一次请求建立连接，请求中携带上一次连接使用过的ip和客户端公钥，服务器检测此ip和客户端公钥的当前状态，检测此ip是否在`ip_available_set`集合中：
   1. 如果存在，说明此ip已释放，当前可用状态，服务器执行第4步的步骤给客户端重新分配ip
   2. 如果不存在，说明此ip当前已用，继续将此ip和客户端公钥进行组合，并在`ip_used_set`集合中查询是否存在
      - A、如果存在说明此ip使用者就是这个客户端，直接将此ip和服务器公钥响应给客户端。
      - B、如果不存在，说明此ip当前其他客户端在使用，服务器执行第4步步骤给客户端重新分配ip。
6. 客户端请求断开连接，请求中附带ip和客户端公钥2个参数，服务器将此ip和客户端公钥进行组合，从 `ip_used_set (srem)` 删除这个组合
   1. 如果删除成功，同时在 `ip_available_set (sadd)` 添加此ip，使此ip变为可用。
   2. 如果删除失败，说明`ip_available_set` 中不存在此记录，忽略本次操作。
7. 由于客户端不能确保每次退出时都发送断开连接请求，导致ip资源一直被占用，需要定时回收资源，服务端定期(定时任务) 采用ping的方式对`ip_used_set` 集合的所有元素的ip进行检测，不能ping通的 从`ip_used_set(srem)` 集合删除，并把此ip添加到`ip_available_set (sadd)`集合，释放ip资源。
8. 若`ip_available_set` 集合为空，客户端请求建立连接，需要分配ip的时候，提示此服务器资源已用尽(code=400)，请连接其他服务器。
9. 客户端在没有退出的状态下，由于某种原因资源被回收。此时客户端检测到不可用时，发送请求到服务器，请求新的资源。



## WireGuard配置文件

采用动态方式添加删除客户端

### 建立连接

1. 客户端建立连接时，首先自己生成publickey(公钥) privatekey(私钥)，请求中携带publickey发送到服务器

2. 服务器收到请求，根据ip资源池规则给客户端分配ip，并在服务器上执行添加客户端配置代码:

   ```
   wg set wg0 peer cpublickey allowed-ips cip/32
   wg-quick save wg0
   ```

最后将ip和服务器公钥下发给客户端。

### 断开连接

1. 客户端断开连接时，请求中携带ip和publickey参数，发送到服务器

2. 服务器收到请求，在服务器上执行删除客户端配置代码:

   ```
   wg set wg0 peer cpublickey remove
   wg-quick save wg0
   ```

3. 根据ip资源池规则释放此ip







# 安装脚本

Git.io/fptwc